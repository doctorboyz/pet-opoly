<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet-opoly - The Pet Adoption Game</title>
    <style>
        /* General Body and Font Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* Prevents scrollbars from confetti */
        }

        /* Main Game Container */
        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 800px;
            width: 100%;
            /* Ensure the container fits the screen and scrolls internally if needed */
            max-height: 95vh;
            overflow-y: auto;
        }

        .game-title {
            text-align: center;
            color: #ff6b6b;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Setup Screen Styles */
        .setup-screen {
            text-align: center;
            padding: 20px;
        }

        .setup-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        .setup-section h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .player-count-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .count-btn {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 15px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .count-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .count-btn.selected {
            border-color: #ff6b6b;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
        }

        .player-setup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .player-config {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .player-config h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .player-name-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
            font-family: inherit;
        }

        .player-name-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .color-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.2);
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .color-red { background: #ff6b6b; }
        .color-blue { background: #4ecdc4; }
        .color-yellow { background: #ffe66d; }
        .color-green { background: #a8e6cf; }
        .color-purple { background: #b19cd9; }
        .color-orange { background: #ffb347; }
        .color-pink { background: #ffb3ba; }
        .color-teal { background: #77dd77; }

        .start-game-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .start-game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .start-game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Screen Styles */
        .game-screen {
            display: none;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            gap: 2px;
            background: #4ecdc4;
            padding: 10px;
            border-radius: 15px;
            aspect-ratio: 1;
            width: 90vmin;
            max-width: 700px;
            margin: 0 auto 30px;
            position: relative; /* For positioning player tokens */
        }

        .space {
            background: white;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            font-size: 0.7rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .space:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Pulse animation for property purchase */
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 10px 15px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        .pulse-highlight {
            animation: pulse-highlight 1s ease-out;
        }

        .corner {
            font-size: 0.6rem;
            font-weight: bold;
        }

        .go { background: linear-gradient(45deg, #ff6b6b, #ffa500); color: white; }
        .jail { background: linear-gradient(45deg, #666, #999); color: white; }
        .free-parking { background: linear-gradient(45deg, #4ecdc4, #45b7aa); color: white; }
        .go-to-jail { background: linear-gradient(45deg, #ff4757, #c44569); color: white; }

        .pet-space {
            background: linear-gradient(45deg, #a8e6cf, #dcedc1);
        }

        .special-space {
            background: linear-gradient(45deg, #ffd93d, #ff6b6b);
            color: white;
        }

        .center {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .pet-emoji {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .price {
            font-size: 0.6rem;
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Player token styles for smooth movement */
        .player {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            position: absolute;
            border: 2px solid white;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: top 0.2s ease-in-out, left 0.2s ease-in-out;
        }

        .money-transfer-coin {
            position: fixed;
            font-size: 2rem;
            z-index: 2000;
            transition: all 1s ease-in-out;
            text-shadow: 0 0 10px gold;
        }

        /* Game Controls and Player Info */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .dice-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dice {
            width: 50px;
            height: 50px;
            background: white;
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .roll-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .roll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .roll-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .game-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 20px;
            align-items: start;
        }

        .player-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .game-stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stats-card h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-label {
            color: #666;
            font-weight: bold;
        }

        .stat-value {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .quick-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            width: 100%;
        }

        .quick-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .player-card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #ff6b6b;
            background: linear-gradient(45deg, #fff5f5, #ffffff);
        }

        .player-card.bankrupt {
            opacity: 0.5;
            background: #e0e0e0;
            filter: grayscale(1);
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .player-money {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .owned-pets {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        /* Generic Modal System Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            color: #ff6b6b;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .modal-body {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 25px;
            white-space: pre-wrap; /* Allows line breaks in text */
        }

        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .modal-btn {
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }
        .modal-btn.primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        .modal-btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
        }
        .modal-btn.secondary {
            background: #ccc;
            color: #333;
        }

        /* Game Over and Confetti Styles */
        .game-over-modal {
            flex-direction: column;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            color: white;
        }
        .game-over-title {
            font-size: 3rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        .winner-name {
            font-size: 2rem;
            color: #ffe66d;
            margin-bottom: 20px;
        }
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            animation: fall 5s linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Message Bar and Action Buttons */
        .message {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
        }

        .action-btn.success {
            background: linear-gradient(45deg, #a8e6cf, #77dd77);
        }

        /* Responsive Design for smaller screens */
        @media (max-width: 768px) {
            .game-title { font-size: 2rem; }
            .board { width: 95vmin; max-width: 95vw; }
            .space { font-size: 0.6rem; padding: 3px; }
            .pet-emoji { font-size: 1rem; }
            .center { font-size: 1.2rem; }
            .player-setup { grid-template-columns: 1fr; }
            .game-layout { 
                grid-template-columns: 1fr; 
                gap: 20px; 
            }
            .game-stats { 
                flex-direction: row; 
                overflow-x: auto; 
            }
            .stats-card { 
                min-width: 250px; 
                flex-shrink: 0; 
            }
        }
    </style>
</head>
<body>
    <!-- Main Game Container -->
    <div class="game-container">
        <h1 class="game-title">🐾 PET-OPOLY 🐾</h1>
        <p class="game-subtitle">Adopt pets, build shelters, and become the ultimate pet parent!</p>
        
        <!-- Setup Screen: Initially visible -->
        <div class="setup-screen" id="setupScreen">
            <!-- Section for selecting number of players -->
            <div class="setup-section">
                <h3>🎮 How many players?</h3>
                <div class="player-count-buttons">
                    <button class="count-btn" data-count="2">2 Players</button>
                    <button class="count-btn" data-count="3">3 Players</button>
                    <button class="count-btn selected" data-count="4">4 Players</button>
                </div>
            </div>
            
            <!-- Section for configuring player names and colors -->
            <div class="setup-section">
                <h3>👥 Player Setup</h3>
                <div class="player-setup" id="playerSetup">
                    <!-- Player config cards will be generated by script.js -->
                </div>
            </div>
            
            <!-- Button to start the game -->
            <button class="start-game-btn" id="startBtn">
                🚀 Start Pet-opoly Adventure!
            </button>
        </div>
        
        <!-- Game Screen: Initially hidden -->
        <div class="game-screen" id="gameScreen">
            <!-- The game board will be generated here by script.js -->
            <div class="board" id="board"></div>
            
            <!-- Controls for rolling dice -->
            <div class="game-controls">
                <div class="dice-container">
                    <div class="dice" id="dice1">🎲</div>
                    <div class="dice" id="dice2">🎲</div>
                    <button class="roll-btn" id="rollBtn">Roll Dice</button>
                </div>
            </div>
            
            <!-- Layout for player cards and game stats -->
            <div class="game-layout">
                <div class="player-info" id="playerInfo">
                    <!-- Player cards will be generated here by script.js -->
                </div>
                
                <div class="game-stats">
                    <!-- Card for general game statistics -->
                    <div class="stats-card">
                        <h3>🏆 Game Stats</h3>
                        <div class="stat-item">
                            <span class="stat-label">Turn:</span>
                            <span class="stat-value" id="turnCounter">1</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Players:</span>
                            <span class="stat-value" id="activePlayers">4</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Money in Play:</span>
                            <span class="stat-value" id="totalMoney">$6000</span>
                        </div>
                    </div>
                    
                    <!-- Card for quick action buttons -->
                    <div class="stats-card">
                        <h3>🎯 Quick Actions</h3>
                        <button class="quick-btn" id="viewPetsBtn">🏠 View All Pets</button>
                        <button class="quick-btn" id="leaderboardBtn">📊 Leaderboard</button>
                        <button class="quick-btn" id="newGameBtn">🔄 New Game</button>
                    </div>
                </div>
            </div>
            
            <!-- Message bar for game updates -->
            <div class="message" id="message">
                Welcome to Pet-opoly!
            </div>
        </div>
    </div>

    <!-- Generic Modal for pop-ups -->
    <div class="modal-overlay" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Game Over Modal with Confetti -->
    <div class="modal-overlay game-over-modal" id="gameOverModal">
        <div class="confetti-container" id="confettiContainer"></div>
        <div class="modal-content" style="background: transparent; box-shadow: none; text-align: center;">
             <h2 class="game-over-title">🎉 GAME OVER! 🎉</h2>
             <h3>The winner is...</h3>
             <h1 class="winner-name" id="winnerName"></h1>
             <button class="modal-btn primary" id="playAgainBtn">Play Again</button>
        </div>
    </div>
    
    <script>
        // ===================================================================================
        // C: Pet-opoly Game Logic
        // ===================================================================================

        document.addEventListener('DOMContentLoaded', () => {

            // ---------------------------------------------------------------------------
            // I. GAME STATE & CONSTANTS
            // ---------------------------------------------------------------------------

            let selectedPlayerCount = 4;
            let playerConfigs = [];
            let players = [];
            let currentPlayer = 0;
            let ownedSpaces = {};
            let turnCounter = 1;
            let isWaitingForAction = false;
            let isGameOver = false;

            // Audio context for sound effects
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // Data for all 40 board spaces
            const boardSpaces = [
                { type: "go", name: "START", text: "🏠 Collect $200 Pet Allowance" },
                { type: "pet", name: "Goldfish Bowl", emoji: "🐠", price: 60, rent: 10 },
                { type: "special", name: "Pet Lottery", text: "🎰 Lucky! Get $150", amount: 150 },
                { type: "pet", name: "Hamster Cage", emoji: "🐹", price: 60, rent: 12 },
                { type: "special", name: "Vet Bill", text: "🧾 Pay $75", amount: -75 },
                { type: "pet", name: "Rabbit Hutch", emoji: "🐰", price: 200, rent: 25 },
                { type: "pet", name: "Cat Tower", emoji: "🐱", price: 100, rent: 15 },
                { type: "special", name: "Pet Treats", text: "🦴 Lucky! Get $100", amount: 100 },
                { type: "pet", name: "Dog House", emoji: "🐶", price: 120, rent: 18 },
                { type: "pet", name: "Bird Perch", emoji: "🦜", price: 140, rent: 20 },
                { type: "jail", name: "VET VISIT", text: "🏥 Just Visiting" },
                { type: "pet", name: "Horse Stable", emoji: "🐴", price: 140, rent: 22 },
                { type: "special", name: "Pet Sponsorship", text: "💝 Get $180!", amount: 180 },
                { type: "pet", name: "Pig Pen", emoji: "🐷", price: 160, rent: 24 },
                { type: "pet", name: "Cow Pasture", emoji: "🐄", price: 180, rent: 26 },
                { type: "special", name: "Grooming Fee", text: "✂️ Pay $50", amount: -50 },
                { type: "pet", name: "Turtle Tank", emoji: "🐢", price: 180, rent: 26 },
                { type: "special", name: "Pet Show", text: "🏆 Win $200!", amount: 200 },
                { type: "pet", name: "Frog Pond", emoji: "🐸", price: 200, rent: 30 },
                { type: "pet", name: "Snake Terrarium", emoji: "🐍", price: 220, rent: 32 },
                { type: "free-parking", name: "PET PARK", text: "🌳 Free Parking" },
                { type: "pet", name: "Monkey Jungle", emoji: "🐵", price: 220, rent: 34 },
                { type: "special", name: "Pet Jackpot", text: "💰 Lucky! Get $250", amount: 250 },
                { type: "pet", name: "Elephant Sanctuary", emoji: "🐘", price: 240, rent: 36 },
                { type: "pet", name: "Lion Den", emoji: "🦁", price: 260, rent: 38 },
                { type: "special", name: "Food Bill", text: "🥕 Pay $100", amount: -100 },
                { type: "pet", name: "Bear Cave", emoji: "🐻", price: 300, rent: 42 },
                { type: "pet", name: "Panda Bamboo", emoji: "🐼", price: 300, rent: 44 },
                { type: "special", name: "Pet Charity", text: "🌟 Get $200!", amount: 200 },
                { type: "pet", name: "Penguin Ice", emoji: "🐧", price: 320, rent: 46 },
                { type: "go-to-jail", name: "LOST PET", text: "🚨 Go to Vet!" },
                { type: "pet", name: "Unicorn Magic", emoji: "🦄", price: 350, rent: 55 },
                { type: "pet", name: "Dragon Lair", emoji: "🐉", price: 400, rent: 60 },
                { type: "special", name: "Pet Treasure", text: "💰 Lucky! Get $350", amount: 350 },
                { type: "pet", name: "Phoenix Nest", emoji: "🔥", price: 400, rent: 65 },
                { type: "special", name: "Luxury Pet Tax", text: "💎 Pay $150", amount: -150 },
                { type: "pet", name: "Octopus Tank", emoji: "🐙", price: 375, rent: 58 },
                { type: "special", name: "Pet Windfall", text: "🌟 Get $400!", amount: 400 },
                { type: "pet", name: "Royal Pets", emoji: "👑", price: 400, rent: 70 }
            ];
            const availableColors = [
                { name: 'Red', class: 'color-red', value: '#ff6b6b' }, { name: 'Blue', class: 'color-blue', value: '#4ecdc4' },
                { name: 'Yellow', class: 'color-yellow', value: '#ffe66d' }, { name: 'Green', class: 'color-green', value: '#a8e6cf' },
                { name: 'Purple', class: 'color-purple', value: '#b19cd9' }, { name: 'Orange', class: 'color-orange', value: '#ffb347' },
                { name: 'Pink', class: 'color-pink', value: '#ffb3ba' }, { name: 'Teal', class: 'color-teal', value: '#77dd77' }
            ];

            // ---------------------------------------------------------------------------
            // II. DOM ELEMENT REFERENCES
            // ---------------------------------------------------------------------------

            const setupScreen = document.getElementById('setupScreen');
            const gameScreen = document.getElementById('gameScreen');
            const playerCountButtons = document.querySelector('.player-count-buttons');
            const playerSetupContainer = document.getElementById('playerSetup');
            const startBtn = document.getElementById('startBtn');
            const boardElement = document.getElementById('board');
            const rollBtn = document.getElementById('rollBtn');
            const dice1Element = document.getElementById('dice1');
            const dice2Element = document.getElementById('dice2');
            const playerInfoContainer = document.getElementById('playerInfo');
            const messageElement = document.getElementById('message');
            const turnCounterElement = document.getElementById('turnCounter');
            const activePlayersElement = document.getElementById('activePlayers');
            const totalMoneyElement = document.getElementById('totalMoney');
            const viewPetsBtn = document.getElementById('viewPetsBtn');
            const leaderboardBtn = document.getElementById('leaderboardBtn');
            const newGameBtn = document.getElementById('newGameBtn');
            const modalOverlay = document.getElementById('genericModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            const gameOverModal = document.getElementById('gameOverModal');
            const winnerNameElement = document.getElementById('winnerName');
            const playAgainBtn = document.getElementById('playAgainBtn');
            const confettiContainer = document.getElementById('confettiContainer');

            // ---------------------------------------------------------------------------
            // III. SETUP LOGIC
            // ---------------------------------------------------------------------------

            /**
             * Handles selection of player count.
             * @param {Event} e - The click event.
             */
            function selectPlayerCount(e) {
                if (e.target.classList.contains('count-btn')) {
                    selectedPlayerCount = parseInt(e.target.dataset.count);
                    document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    generatePlayerSetup();
                }
            }

            /**
             * Generates the UI for player name and color configuration.
             */
            function generatePlayerSetup() {
                playerSetupContainer.innerHTML = '';
                playerConfigs = [];
                for (let i = 0; i < selectedPlayerCount; i++) {
                    const playerConfig = document.createElement('div');
                    playerConfig.className = 'player-config';
                    const defaultColor = availableColors[i % availableColors.length];
                    playerConfigs.push({ name: `Player ${i + 1}`, color: defaultColor });
                    playerConfig.innerHTML = `
                        <h4>Player ${i + 1}</h4>
                        <input type="text" class="player-name-input" value="Player ${i + 1}" data-player-index="${i}">
                        <div class="color-options" data-player-index="${i}">
                            ${availableColors.map((c, ci) => `<div class="color-option ${c.class} ${ci === i ? 'selected' : ''}" data-color-index="${ci}"></div>`).join('')}
                        </div>`;
                    playerSetupContainer.appendChild(playerConfig);
                }
                updateStartButton();
            }

            /**
             * Updates a player's name in the config.
             * @param {Event} e - The input event.
             */
            function updatePlayerName(e) {
                if (e.target.classList.contains('player-name-input')) {
                    const playerIndex = parseInt(e.target.dataset.playerIndex);
                    playerConfigs[playerIndex].name = e.target.value || `Player ${playerIndex + 1}`;
                    updateStartButton();
                }
            }

            /**
             * Handles selection of a player's color.
             * @param {Event} e - The click event.
             */
            function selectPlayerColor(e) {
                if (e.target.classList.contains('color-option')) {
                    const playerIndex = parseInt(e.target.parentElement.dataset.playerIndex);
                    const colorIndex = parseInt(e.target.dataset.colorIndex);
                    const selectedColor = availableColors[colorIndex];

                    if (playerConfigs.some((c, i) => i !== playerIndex && c.color.class === selectedColor.class)) {
                        playSound('error');
                        showModal('Color Taken!', 'This color is already taken! Please choose another.', [{ text: 'OK', class: 'primary' }]);
                        return;
                    }
                    playerConfigs[playerIndex].color = selectedColor;
                    const playerConfigElement = e.target.closest('.player-config');
                    playerConfigElement.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    e.target.classList.add('selected');
                    updateStartButton();
                }
            }

            /**
             * Enables or disables the start button based on valid configuration.
             */
            function updateStartButton() {
                const allNamesValid = playerConfigs.every(c => c.name.trim().length > 0);
                const allColorsUnique = new Set(playerConfigs.map(c => c.color.class)).size === playerConfigs.length;
                startBtn.disabled = !allNamesValid || !allColorsUnique;
            }

            /**
             * Initializes the game state and transitions from setup to game screen.
             */
            function startGame() {
                initAudio();
                players = playerConfigs.map((config, index) => ({
                    id: index, name: config.name, money: 1500, position: 0,
                    pets: [], color: config.color.value, isBankrupt: false, marker: null
                }));
                setupScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                initializeBoard();
                showMessage(`${players[0].name}'s turn to roll!`);
            }

            // ---------------------------------------------------------------------------
            // IV. GAME INITIALIZATION
            // ---------------------------------------------------------------------------

            /**
             * Creates the game board and player tokens in the DOM.
             */
            function initializeBoard() {
                boardElement.innerHTML = '';
                for (let i = 0; i < 40; i++) {
                    const space = document.createElement('div');
                    space.className = 'space';
                    space.id = `space-${i}`;
                    const sd = boardSpaces[i];
                    if (['go', 'jail', 'free-parking', 'go-to-jail'].includes(sd.type)) space.classList.add('corner', sd.type);
                    else if (sd.type === 'pet') space.classList.add('pet-space');
                    else space.classList.add('special-space');

                    if (i <= 10) { space.style.gridRow = '11'; space.style.gridColumn = `${11 - i}`; } 
                    else if (i <= 20) { space.style.gridColumn = '1'; space.style.gridRow = `${11 - (i - 10)}`; } 
                    else if (i <= 30) { space.style.gridRow = '1'; space.style.gridColumn = `${i - 20 + 1}`; } 
                    else { space.style.gridColumn = '11'; space.style.gridRow = `${i - 30 + 1}`; }
                    
                    space.innerHTML = sd.emoji ? `<div class="pet-emoji">${sd.emoji}</div><div>${sd.name}</div><div class="price">$${sd.price}</div>`
                                                : `<div style="font-weight: bold;">${sd.name}</div><div style="font-size: 0.6rem;">${sd.text}</div>`;
                    space.addEventListener('click', () => showSpaceInfo(i));
                    boardElement.appendChild(space);
                }
                const center = document.createElement('div');
                center.className = 'center';
                center.innerHTML = `<div>🐾 PET-OPOLY 🐾</div><div style="font-size: 1rem; margin-top: 10px;">Adopt • Care • Love</div>`;
                boardElement.appendChild(center);
                
                players.forEach((player, index) => {
                    const marker = document.createElement('div');
                    marker.className = 'player';
                    marker.style.backgroundColor = player.color;
                    marker.style.zIndex = 10 + index;
                    boardElement.appendChild(marker);
                    player.marker = marker;
                });

                teleportAllPlayersToPosition();
                updatePlayerInfo();
            }

            // ---------------------------------------------------------------------------
            // V. CORE GAMEPLAY LOOP
            // ---------------------------------------------------------------------------

            /**
             * Handles the dice roll action.
             */
            function rollDice() {
                if (isWaitingForAction || isGameOver) return;
                initAudio(); 
                playSound('diceRoll');
                const dice1 = Math.floor(Math.random() * 6) + 1;
                const dice2 = Math.floor(Math.random() * 6) + 1;
                dice1Element.textContent = dice1;
                dice2Element.textContent = dice2;
                rollBtn.disabled = true;
                movePlayer(dice1 + dice2);
            }

            /**
             * Initiates the player movement animation.
             * @param {number} spaces - The total number of spaces to move.
             */
            function movePlayer(spaces) {
                const player = players[currentPlayer];
                const oldPosition = player.position;
                animatePlayerMovement(spaces, () => {
                    if (player.position < oldPosition && !player.isBankrupt) {
                        player.money += 200;
                        showMessage(`${player.name} passed START and collected $200! 🏠`);
                    }
                    playSound('landing');
                    handleSpaceLanding();
                });
            }

            /**
             * Animates a player token one space at a time.
             * @param {number} spacesToMove - The remaining spaces to move.
             * @param {function} onComplete - Callback function when movement is finished.
             */
            function animatePlayerMovement(spacesToMove, onComplete) {
                if (spacesToMove === 0) {
                    onComplete();
                    return;
                }
                const player = players[currentPlayer];
                player.position = (player.position + 1) % 40;
                const targetSpace = document.getElementById(`space-${player.position}`);
                const boardRect = boardElement.getBoundingClientRect();
                const spaceRect = targetSpace.getBoundingClientRect();
                const top = spaceRect.top - boardRect.top + 5 + (player.id % 2 * 20);
                const left = spaceRect.left - boardRect.left + 5 + (Math.floor(player.id / 2) * 20);
                player.marker.style.top = `${top}px`;
                player.marker.style.left = `${left}px`;
                playSound('step');
                setTimeout(() => animatePlayerMovement(spacesToMove - 1, onComplete), 210);
            }

            /**
             * Handles the logic for the space the player landed on.
             */
            function handleSpaceLanding() {
                if (isGameOver) return;
                const player = players[currentPlayer];
                const space = boardSpaces[player.position];
                let continueTurn = true;
                let timeout = 3000;

                if (space.type === 'pet') {
                    const ownerIndex = ownedSpaces[player.position];
                    if (ownerIndex !== undefined) {
                        if (ownerIndex !== currentPlayer) {
                            showMessage(`${player.name} must pay $${space.rent} rent to ${players[ownerIndex].name}!`);
                            if (!handlePayment(currentPlayer, space.rent, ownerIndex)) continueTurn = false;
                        }
                    } else {
                        if (player.money >= space.price) {
                            showPurchaseDialog(space, player.position);
                            return; // Wait for player action
                        } else {
                            showMessage(`${player.name} can't afford to adopt ${space.name}.`);
                        }
                    }
                } else if (space.type === 'special') {
                    const amount = space.amount;
                    if (amount < 0) {
                        showMessage(`${player.name} landed on ${space.name} and must pay $${-amount}.`);
                        if (!handlePayment(currentPlayer, -amount)) continueTurn = false;
                    } else {
                        player.money += amount;
                        showMessage(`Lucky! ${player.name} ${space.text}`);
                    }
                } else if (space.type === 'go-to-jail') {
                    player.position = 10;
                    teleportPlayerToPosition(player);
                    showMessage(`${player.name}'s pet got lost! Go to the vet! 🏥`);
                } else {
                    showMessage(`${player.name} landed on ${space.name}.`);
                }
                
                if (continueTurn) {
                    updatePlayerInfo();
                    setTimeout(nextPlayerTurn, timeout);
                } else {
                    setTimeout(nextPlayerTurn, timeout);
                }
            }

            /**
             * Advances to the next active player's turn.
             */
            function nextPlayerTurn() {
                if (isGameOver) return;
                const activePlayerCount = players.filter(p => !p.isBankrupt).length;
                if (activePlayerCount <= 1) return;

                do {
                    currentPlayer = (currentPlayer + 1) % players.length;
                } while (players[currentPlayer].isBankrupt);

                if (players.filter(p => !p.isBankrupt).every(p => p.id === currentPlayer)) {
                    turnCounter++;
                }
                updatePlayerInfo();
                rollBtn.disabled = false;
                isWaitingForAction = false;
                showMessage(`${players[currentPlayer].name}'s turn! Roll the dice! 🎲`);
            }

            // ---------------------------------------------------------------------------
            // VI. ACTION & DECISION LOGIC
            // ---------------------------------------------------------------------------

            /**
             * Processes a payment from one player to another or to the bank.
             * @param {number} payerIndex - The index of the player paying.
             * @param {number} amount - The amount to pay.
             * @param {number} [recipientIndex=-1] - The index of the recipient. -1 for the bank.
             * @returns {boolean} - True if payment was successful, false if bankrupt.
             */
            function handlePayment(payerIndex, amount, recipientIndex = -1) {
                const payer = players[payerIndex];
                if (payer.money >= amount) {
                    payer.money -= amount;
                    if (recipientIndex !== -1) {
                        players[recipientIndex].money += amount;
                        animateMoneyTransfer(payerIndex, recipientIndex);
                    }
                    playSound('payment');
                    updatePlayerInfo();
                    return true;
                } else {
                    handleBankruptcy(payerIndex);
                    return false;
                }
            }

            /**
             * Handles a player's bankruptcy.
             * @param {number} playerIndex - The index of the bankrupt player.
             */
            function handleBankruptcy(playerIndex) {
                const player = players[playerIndex];
                if (player.isBankrupt) return;
                player.isBankrupt = true;
                player.money = 0;
                player.marker.style.display = 'none';
                playSound('error');
                showMessage(`Oh no! ${player.name} has gone bankrupt! 💸`);
                for (const spaceId in ownedSpaces) {
                    if (ownedSpaces[spaceId] === playerIndex) {
                        delete ownedSpaces[spaceId];
                        const spaceElement = document.getElementById(`space-${spaceId}`);
                        spaceElement.style.borderColor = '#333';
                        spaceElement.style.borderWidth = '2px';
                    }
                }
                player.pets = [];
                updatePlayerInfo();
                checkForWinner();
            }

            /**
             * Checks if there is a winner and ends the game if so.
             */
            function checkForWinner() {
                const activePlayers = players.filter(p => !p.isBankrupt);
                if (activePlayers.length === 1 && !isGameOver) {
                    isGameOver = true;
                    setTimeout(() => triggerGameOver(activePlayers[0]), 2000);
                }
            }

            /**
             * Displays the purchase dialog in the message bar.
             * @param {object} space - The space data object.
             * @param {number} position - The board position index.
             */
            function showPurchaseDialog(space, position) {
                isWaitingForAction = true;
                rollBtn.disabled = true;
                messageElement.innerHTML = `
                    <div>
                        <div style="margin-bottom: 10px;">${space.emoji} <strong>Adopt ${space.name} for $${space.price}?</strong></div>
                        <div class="action-buttons">
                            <button class="action-btn success" id="buyBtn">✅ Adopt!</button>
                            <button class="action-btn danger" id="skipBtn">❌ Skip</button>
                        </div>
                    </div>`;
                document.getElementById('buyBtn').onclick = () => buyPet(position);
                document.getElementById('skipBtn').onclick = skipPurchase;
            }

            /**
             * Handles the logic for buying a pet.
             * @param {number} position - The board position index.
             */
            function buyPet(position) {
                isWaitingForAction = false;
                const player = players[currentPlayer];
                const space = boardSpaces[position];
                player.money -= space.price;
                player.pets.push(space.name);
                ownedSpaces[position] = currentPlayer;
                const el = document.getElementById(`space-${position}`);
                el.style.borderColor = player.color;
                el.style.borderWidth = '3px';
                el.classList.add('pulse-highlight');
                setTimeout(() => el.classList.remove('pulse-highlight'), 1000);
                playSound('purchase');
                showMessage(`🎉 ${player.name} adopted ${space.name}!`);
                updatePlayerInfo();
                setTimeout(nextPlayerTurn, 2000);
            }

            /**
             * Handles the logic for skipping a purchase.
             */
            function skipPurchase() {
                isWaitingForAction = false;
                showMessage(`${players[currentPlayer].name} decided not to adopt.`);
                setTimeout(nextPlayerTurn, 2000);
            }

            // ---------------------------------------------------------------------------
            // VII. UI & MODAL SYSTEM
            // ---------------------------------------------------------------------------

            /**
             * Instantly moves all player tokens to their current positions.
             */
            function teleportAllPlayersToPosition() {
                const boardRect = boardElement.getBoundingClientRect();
                players.forEach((player) => {
                    teleportPlayerToPosition(player, boardRect);
                });
            }

            /**
             * Instantly moves a single player token to its current position.
             * @param {object} player - The player object.
             * @param {DOMRect} [boardRect] - Optional pre-calculated board rectangle.
             */
            function teleportPlayerToPosition(player, boardRect) {
                if (player.isBankrupt) {
                    player.marker.style.display = 'none';
                    return;
                }
                if (!boardRect) boardRect = boardElement.getBoundingClientRect();
                const spaceEl = document.getElementById(`space-${player.position}`);
                const spaceRect = spaceEl.getBoundingClientRect();
                const top = spaceRect.top - boardRect.top + 5 + (player.id % 2 * 20);
                const left = spaceRect.left - boardRect.left + 5 + (Math.floor(player.id / 2) * 20);
                player.marker.style.top = `${top}px`;
                player.marker.style.left = `${left}px`;
            }

            /**
             * Updates all player info cards in the UI.
             */
            function updatePlayerInfo() {
                playerInfoContainer.innerHTML = '';
                players.forEach((player, index) => {
                    const card = document.createElement('div');
                    card.id = `player-card-${index}`;
                    card.className = `player-card ${index === currentPlayer ? 'active' : ''} ${player.isBankrupt ? 'bankrupt' : ''}`;
                    card.innerHTML = `
                        <div class="player-name" style="color: ${player.color}">${player.name} ${player.isBankrupt ? '(Bankrupt)' : ''}</div>
                        <div class="player-money">$${player.money}</div>
                        <div class="owned-pets">Pets: ${player.pets.length}</div>`;
                    playerInfoContainer.appendChild(card);
                });
                updateGameStats();
            }

            /**
             * Updates the main game statistics display.
             */
            function updateGameStats() {
                turnCounterElement.textContent = turnCounter;
                activePlayersElement.textContent = players.filter(p => !p.isBankrupt).length;
                totalMoneyElement.textContent = `$${players.reduce((s, p) => s + p.money, 0)}`;
            }

            /**
             * Displays a message in the main message bar.
             * @param {string} text - The message to display.
             */
            function showMessage(text) {
                messageElement.innerHTML = text;
            }

            /**
             * Shows the generic modal with custom content.
             * @param {string} title - The title for the modal.
             * @param {string} content - The body content for the modal.
             * @param {Array<object>} buttons - An array of button configuration objects.
             */
            function showModal(title, content, buttons) {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modalFooter.innerHTML = '';
                buttons.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = `modal-btn ${b.class}`;
                    btn.textContent = b.text;
                    btn.onclick = () => {
                        closeModal();
                        if (b.callback) b.callback();
                    };
                    modalFooter.appendChild(btn);
                });
                modalOverlay.style.display = 'flex';
            }

            /**
             * Hides the generic modal.
             */
            function closeModal() {
                modalOverlay.style.display = 'none';
            }

            /**
             * Shows the game over screen and starts confetti.
             * @param {object} winner - The winning player object.
             */
            function triggerGameOver(winner) {
                playSound('win');
                winnerNameElement.textContent = winner.name;
                winnerNameElement.style.color = winner.color;
                gameOverModal.style.display = 'flex';
                startConfetti();
            }

            /**
             * Creates and animates confetti elements.
             */
            function startConfetti() {
                confettiContainer.innerHTML = '';
                const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#a8e6cf', '#b19cd9', '#ffb347'];
                for (let i = 0; i < 150; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.animationDelay = `${Math.random() * 3}s`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
                    confettiContainer.appendChild(confetti);
                }
            }

            /**
             * Animates a coin icon moving between player cards.
             * @param {number} fromPlayerIndex - The index of the paying player.
             * @param {number} toPlayerIndex - The index of the receiving player.
             */
            function animateMoneyTransfer(fromPlayerIndex, toPlayerIndex) {
                const fromCard = document.getElementById(`player-card-${fromPlayerIndex}`);
                const toCard = document.getElementById(`player-card-${toPlayerIndex}`);
                if (!fromCard || !toCard) return;
                const fromRect = fromCard.getBoundingClientRect();
                const toRect = toCard.getBoundingClientRect();
                const coin = document.createElement('div');
                coin.className = 'money-transfer-coin';
                coin.textContent = '💰';
                document.body.appendChild(coin);
                coin.style.left = `${fromRect.left + fromRect.width / 2}px`;
                coin.style.top = `${fromRect.top + fromRect.height / 2}px`;
                coin.style.opacity = '1';
                setTimeout(() => {
                    coin.style.left = `${toRect.left + toRect.width / 2}px`;
                    coin.style.top = `${toRect.top + toRect.height / 2}px`;
                    coin.style.transform = 'scale(0.5)';
                    coin.style.opacity = '0';
                }, 50);
                setTimeout(() => document.body.removeChild(coin), 1050);
            }

            // ---------------------------------------------------------------------------
            // VIII. QUICK ACTION HANDLERS
            // ---------------------------------------------------------------------------

            function showSpaceInfo(i) {
                const s = boardSpaces[i];
                let c = ``;
                if (s.emoji) c += `${s.emoji}\n\n`;
                if (s.price) {
                    c += `Price: $${s.price}\nRent: $${s.rent}\n\n`;
                    const oi = ownedSpaces[i];
                    c += oi !== undefined ? `Owner: ${players[oi].name}` : 'Available for adoption!';
                } else {
                    c += s.text;
                }
                showModal(s.name, c, [{ text: 'Close', class: 'primary' }]);
            }
            
            function showAllProperties() {
                let list = "🏠 ALL PETS IN GAME:\n\n";
                boardSpaces.forEach((s, i) => {
                    if (s.type === 'pet') {
                        const oi = ownedSpaces[i];
                        list += `${s.emoji} ${s.name} ($${s.price})\n  - Owner: ${oi !== undefined ? players[oi].name : 'Available'}\n\n`;
                    }
                });
                showModal('All Pets', list, [{ text: 'Close', class: 'primary' }]);
            }
            
            function showLeaderboard() {
                let list = "🏆 CURRENT LEADERBOARD:\n(Based on cash)\n\n";
                [...players].sort((a, b) => b.money - a.money).forEach((p, i) => {
                    list += `${i + 1}. ${p.name} - $${p.money} ${p.isBankrupt ? '(Bankrupt)' : ''}\n`;
                });
                showModal('Leaderboard', list, [{ text: 'Close', class: 'primary' }]);
            }
            
            function askResetGame() {
                showModal('New Game?', 'Are you sure? All progress will be lost!', [
                    { text: 'Yes, New Game', class: 'danger', callback: () => location.reload() },
                    { text: 'No, Cancel', class: 'secondary' }
                ]);
            }

            // ---------------------------------------------------------------------------
            // IX. EVENT LISTENERS & INITIALIZATION
            // ---------------------------------------------------------------------------

            // Setup screen listeners
            playerCountButtons.addEventListener('click', selectPlayerCount);
            playerSetupContainer.addEventListener('input', updatePlayerName);
            playerSetupContainer.addEventListener('click', selectPlayerColor);
            startBtn.addEventListener('click', startGame);

            // Game screen listeners
            rollBtn.addEventListener('click', rollDice);
            viewPetsBtn.addEventListener('click', showAllProperties);
            leaderboardBtn.addEventListener('click', showLeaderboard);
            newGameBtn.addEventListener('click', askResetGame);
            playAgainBtn.addEventListener('click', () => location.reload());

            // Initial call to set up the first screen
            generatePlayerSetup();
        });
    </script>
</body>
</html>
